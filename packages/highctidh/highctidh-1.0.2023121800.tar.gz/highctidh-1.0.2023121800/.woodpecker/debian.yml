matrix:
  platform:
    - linux/amd64
    - linux/arm64
  CC:
    - clang
    - gcc
  DIST:
    - sid
    - bookworm
  ARCH:
    - amd64

steps:
  debian-${DIST}-${CC}:
    group: compile-debian-${DIST}-${CC}
    image: debian:${DIST}
    commands:
      - export CI=true
      - PATH=$PATH:~/.local/bin
      - export WORKDIR=`pwd`
      - ./misc/install-debian-minimal-deps.sh
      - export CC=${CC}
      - CC=${CC} make
      - ls -alh *.so
      - sha256sum *.so
  debian-${DIST}-${platform}-python-${CC}:
    group: compile-debian-${DIST}-${CC}-python
    image: debian:${DIST}
    commands:
      - export CI=true
      - PATH=$PATH:~/.local/bin
      - export WORKDIR=`pwd`
      - ./misc/install-debian-deps.sh
      - export CC=${CC}
      - CC=${CC} make -f Makefile.packages packages
      - dpkg -i dist/python3-highctidh_*.deb
      - pytest-3 -v -n`nproc` --doctest-modules
      - apt remove -y python3-highctidh
      - sha256sum dist/*.deb
      - ls -alh dist/*.deb
      - sha256sum dist/*.whl
      - ls -alh dist/*.whl
