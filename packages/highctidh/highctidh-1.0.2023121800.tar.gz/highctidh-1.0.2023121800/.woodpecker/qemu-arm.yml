matrix:
  CC:
    - clang
  DIST:
    - bookworm
  ARCH:
    - arm64v8
    - arm32v5
    - arm32v7

steps:
  debian-${DIST}-python-${ARCH}-${CC}:
    group: compile-debian-python-${DIST}-${ARCH}-${CC}
    image: ${ARCH}/python:3.12-${DIST}
    environment:
      - DEBIAN_FRONTEND=noninteractive
    commands:
      - export CI=true
      - PATH=$PATH:~/.local/bin
      - export WORKDIR=`pwd`
      - ./misc/install-debian-sid-deps.sh
      - ./misc/docker-fixup.sh
      - export SOURCE_DATE_EPOCH=`git log -1 --pretty=%ct`
      - export CC=${CC}
      - CC=${CC} make clean
      - mkdir -p dist/source
      - mkdir -p build/tmp
      - pip3.12 install pytest pytest-xdist
      - CC=${CC} python3 setup.py install
      - python3.12 -m pytest -v -n`nproc` --doctest-modules
