//>>built
define("dgrid/OnDemandList","./List ./_StoreMixin dojo/_base/declare dojo/_base/lang dojo/dom-construct dojo/on dojo/when ./util/misc".split(" "),function(y,F,G,H,p,I,J,r){return G([y,F],{minRowsPerPage:25,maxRowsPerPage:250,maxEmptySpace:Infinity,bufferRows:10,farOffRemoval:2E3,queryRowsOverlap:0,pagingMethod:"debounce",pagingDelay:r.defaultDelay,keepScrollPosition:!1,rowHeight:0,postCreate:function(){this.inherited(arguments);var c=this;I(this.bodyNode,"scroll",r[this.pagingMethod](function(d){c._processScroll(d)},
null,this.pagingDelay))},renderQuery:function(c,d){var f=this,l=d&&d.container||this.contentNode,b={query:c,count:0},h,a=this.preload,x={node:p.create("div",{className:"dgrid-preload",style:{height:"0"}},l),count:0,query:c,next:b};x.node.rowIndex=0;b.node=h=p.create("div",{className:"dgrid-preload"},l);b.previous=x;h.rowIndex=this.minRowsPerPage;a?((b.next=a.next)&&h.offsetTop>=a.node.offsetTop?b.previous=a:(b.next=a,b.previous=a.previous),b.previous.next=b,b.next.previous=b):this.preload=b;var q=
p.create("div",{className:"dgrid-loading"},h,"before");p.create("div",{className:"dgrid-below"},q).innerHTML=this.loadingMessage;d=H.mixin({start:0,count:this.minRowsPerPage},"level"in c?{queryLevel:c.level}:null);return this._trackError(function(){var a=c(d);return f.renderQueryResults(a,h,d).then(function(c){return a.totalLength.then(function(a){var l=c.length,e=h.parentNode;f._rows&&(f._rows.min=0,f._rows.max=l===a?Infinity:l-1);p.destroy(q);"queryLevel"in d||(f._total=a);0===a&&e&&(f.noDataNode&&
p.destroy(f.noDataNode),f._insertNoDataNode(e));f._calcAverageRowHeight(c);a-=l;b.count=a;h.rowIndex=l;a?h.style.height=Math.min(a*f.rowHeight,f.maxEmptySpace)+"px":h.style.display="none";f._previousScrollPosition&&(f.scrollTo(f._previousScrollPosition),delete f._previousScrollPosition);return J(f._processScroll()).then(function(){return c})})}).otherwise(function(a){p.destroy(q);throw a;})})},refresh:function(c){var d=this,f=c&&c.keepScrollPosition;"undefined"===typeof f&&(f=this.keepScrollPosition);
f&&(this._previousScrollPosition=this.getScrollPosition());this.inherited(arguments);if(this._renderedCollection)return this.renderQuery(function(c){return d._renderedCollection.fetchRange({start:c.start,end:c.start+c.count})}).then(function(){d._emitRefreshComplete()})},resize:function(){this.inherited(arguments);this.rowHeight||this._calcAverageRowHeight(this.contentNode.getElementsByClassName("dgrid-row"));this._processScroll()},cleanup:function(){this.inherited(arguments);this.preload=null},renderQueryResults:function(c){var d=
this.inherited(arguments),f=this._renderedCollection;f&&f.releaseRange&&d.then(function(d){d[0]&&!d[0].parentNode.tagName&&c.totalLength.then(function(){f.releaseRange(d[0].rowIndex,d[d.length-1].rowIndex+1)})});return d},_getFirstRowSibling:function(c){return c.lastChild},_calcRowHeight:function(c){var d=c.nextSibling;return d&&!/\bdgrid-preload\b/.test(d.className)?d.offsetTop-c.offsetTop:c.offsetHeight},_calcAverageRowHeight:function(c){for(var d=c.length,f=0,l=0;l<d;l++)f+=this._calcRowHeight(c[l]);
d&&f&&(this.rowHeight=f/d)},lastScrollTop:0,_processScroll:function(c){function d(a,c,d,g){var k=b.farOffRemoval,u=a.node;if(c>2*k){for(var h,e=u[d],l=0,A=0,m=[],n=e&&e.rowIndex,t;h=e;){var q=b._calcRowHeight(h);if(l+q+k>c||0>e.className.indexOf("dgrid-row")&&0>e.className.indexOf("dgrid-loading"))break;e=h[d];l+=q;A+=h.count||1;b.removeRow(h,!0);m.push(h);"rowIndex"in h&&(t=h.rowIndex)}b._renderedCollection.releaseRange&&"number"===typeof n&&"number"===typeof t&&(g?b._renderedCollection.releaseRange(t,
n+1):b._renderedCollection.releaseRange(n,t+1),b._rows[g?"max":"min"]=t,b._rows.max>=b._total-1&&(b._rows.max=Infinity));a.count+=A;g?(u.rowIndex-=A,f(a)):u.style.height=u.offsetHeight+l+"px";var r=document.createElement("div");for(a=m.length;a--;)r.appendChild(m[a]);setTimeout(function(){p.destroy(r)},1)}}function f(a,c){a.node.style.height=Math.min(a.count*b.rowHeight,c?Infinity:b.maxEmptySpace)+"px"}function l(a,b){do a=b?a.next:a.previous;while(a&&!a.node.offsetWidth);return a}if(this.rowHeight){var b=
this,h=b.bodyNode;c=c&&c.scrollTop||this.getScrollPosition().y;h=h.offsetHeight+c;var a=b.preload,x=b.lastScrollTop,q=b.bufferRows*b.rowHeight,r=q-b.rowHeight,E,z=!0;for(b.lastScrollTop=c;a&&!a.node.offsetWidth;)a=a.previous;for(;a&&a!==y;){var y=b.preload;b.preload=a;var e=a.node;var g=e.offsetTop;if(h+1+r<g)a=l(a,z=!1);else if(c-1-r>g+e.offsetHeight)a=l(a,z=!0);else{g=((e.rowIndex?c-q:h)-g)/b.rowHeight;var k=(h-c+2*q)/b.rowHeight;k+=Math.min(Math.abs(Math.max(Math.min((c-x)*b.rowHeight,b.maxRowsPerPage/
2),b.maxRowsPerPage/-2)),10);0===e.rowIndex&&(g-=k);g=Math.max(g,0);10>g&&0<g&&k+g<b.maxRowsPerPage&&(k+=Math.max(0,g),g=0);k=Math.min(Math.max(k,b.minRowsPerPage),b.maxRowsPerPage,a.count);if(0===k)a=l(a,z);else{k=Math.ceil(k);g=Math.min(Math.floor(g),a.count-k);var m={};a.count-=k;var n=e,v=b.queryRowsOverlap,B=(0<e.rowIndex||e.offsetTop>c)&&a;if(B){var w=a.previous;w&&(d(w,c-(w.node.offsetTop+w.node.offsetHeight),"nextSibling"),0<g&&w.node===e.previousSibling?(g=Math.min(a.count,g),a.previous.count+=
g,f(a.previous,!0),e.rowIndex+=g,v=0):k+=g,a.count-=g);m.start=e.rowIndex-v;m.count=Math.min(k+v,b.maxRowsPerPage);e.rowIndex=m.start+m.count}else{if(a.next)if(d(a.next,a.next.node.offsetTop-h,"previousSibling",!0),n=e.nextSibling,n===a.next.node)a.next.count+=a.count-g,a.next.node.rowIndex=g+k,f(a.next),a.count=g,v=0;else var C=!0;m.start=a.count;m.count=Math.min(k+v,b.maxRowsPerPage)}C&&n&&n.offsetWidth&&(C=n.offsetTop);f(a);"level"in a.query&&(m.queryLevel=a.query.level);if("queryLevel"in m||!(m.start>
b._total||0>m.count)){var D=p.create("div",{className:"dgrid-loading",style:{height:k*b.rowHeight+"px"}},n,"before");p.create("div",{className:"dgrid-"+(B?"below":"above"),innerHTML:b.loadingMessage},D);D.count=k;b._trackError(function(){(function(c,d,g){var h=a.query(m);E=b.renderQueryResults(h,c,m).then(function(a){var e=b._rows;!e||"queryLevel"in m||!a.length||(d?(e.max<=e.min&&(e.min=a[0].rowIndex),e.max=a[a.length-1].rowIndex):(e.max<=e.min&&(e.max=a[a.length-1].rowIndex),e.min=a[0].rowIndex));
n=c.nextSibling;p.destroy(c);g&&n&&n.offsetWidth&&(e=b.getScrollPosition(),b.scrollTo({x:e.x,y:e.y+n.offsetTop-g,preserveMomentum:!0}));h.totalLength.then(function(a){"queryLevel"in m||(b._total=a,b._rows&&b._rows.max>=b._total-1&&(b._rows.max=Infinity));d&&(d.count=a-d.node.rowIndex,f(d))});b._processScroll();return a},function(a){p.destroy(c);throw a;})})(D,B,C)});a=a.previous}}}}return E}}})});
//# sourceMappingURL=OnDemandList.js.map