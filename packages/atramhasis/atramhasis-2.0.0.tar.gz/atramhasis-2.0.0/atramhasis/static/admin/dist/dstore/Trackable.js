//>>built
define("dstore/Trackable","dojo/_base/lang dojo/_base/declare dojo/aspect dojo/when dojo/promise/all dojo/_base/array dojo/on".split(" "),function(D,z,H,B,p,E,I){function F(d,k,u){for(var r=d.length-1;0<=r;--r){var m=d[r],y=m.start;m=y+m.count;if(k>m){d.splice(r+1,0,{start:k,count:u-k});return}u>=y&&(k=Math.min(k,y),u=Math.max(u,m),d.splice(r,1))}d.unshift({start:k,count:u-k})}var J=0,C={track:function(){function d(){return function(){var c=this,a=this.inherited(arguments);B(a,function(a){a=c._results=
a.slice();c._partialResults&&(c._partialResults=null);c._ranges=[];F(c._ranges,0,a.length)});return a}}function k(){return function(c){var a=this,e=c.start,n=c.end,f=this.inherited(arguments);this._results||B(f,function(b){return B(b.totalLength,function(c){var f=a._partialResults||(a._partialResults=[]);n=Math.min(n,e+b.length);f.length=c;c=[e,n-e].concat(b);f.splice.apply(f,c);F(a._ranges,e,n);return b})});return f}}function u(c,a){J++;var e=a.target;a=D.delegate(a,C[c]);var n=a.beforeId;B(t._results||
t._partialResults,function(f){if(f){var b,d,l=t._ranges,k="id"in a?a.id:r.getIdentity(e),m=-1,v=-1,q=-1,w=-1;if("delete"===c||"update"===c)for(b=0;-1===m&&b<l.length;++b){var g=l[b];var h=g.start;for(d=h+g.count;h<d;++h)if(r.getIdentity(f[h])==k){m=a.previousIndex=h;v=b;var p=n==k;f.splice(m,1);g.count--;for(h=b+1;h<l.length;++h)l[h].start--;break}}if("add"===c||"update"===c){if(A){if(A([e]).length){var x=0;d=l.length-1;for(p=-1;x<=d&&-1===q;)b=x+Math.round((d-x)/2),g=l[b],v=f.slice(g.start,g.start+
g.count),void 0!==n&&(p=null===n?v.length:G(v,n)),-1===p&&(p=m>=Math.max(0,g.start-1)&&m<=g.start+g.count?m:r.defaultNewToStart?0:v.length),v.splice(p,0,e),h=E.indexOf(A(v),e),k=g.start+h,0===h&&0!==g.start?d=b-1:h>=v.length-1&&k<f.length?x=b+1:(q=k,w=b);if(-1===q&&0<x&&x<l.length)var u=!0}}else{h=-1;if(void 0===n||p)"update"===c?(q=m,w=v):r.defaultNewToStart?h=q=0:(q=f.length,h=l.length-1);else if(null===n)q=f.length,h=l.length-1;else for(b=0,d=l.length;-1===w&&b<d;++b)g=l[b],q=G(f,n,g.start,g.start+
g.count),-1!==q&&(w=b);-1!==h&&-1===w&&(g=l[h])&&g.start<=q&&q<=g.start+g.count&&(w=h)}if(-1<q&&-1<w)for(a.index=q,f.splice(q,0,e),l[w].count++,b=w+1;b<l.length;++b)l[b].start++;else if(u)for(a.beforeIndex=l[x].start,b=x;b<l.length;++b)l[b].start++}a.totalLength=f.length}(f=t["on_tracked"+c])&&f.call(t,a)})}var r=this.store||this,m=[],y={add:1,update:1,"delete":1},p;for(p in y)m.push(this.on(p,function(c){return function(a){u(c,a)}}(p)));var t=z.safeMixin(D.delegate(this),{_ranges:[],fetch:d(),fetchRange:k(),
releaseRange:function(c,a){if(this._partialResults){a:for(var e=this._ranges,n=0,f;f=e[n];++n){var b=f.start,d=b+f.count;if(c<=b)if(a>=d)e.splice(n,1);else{f.start=a;f.count=d-f.start;break a}else if(c<d)if(a>b){e.splice(n,1,{start:b,count:c-b},{start:a,count:d-a});break a}else f.count=c-f.start}for(e=c;e<a;++e)delete this._partialResults[e]}},on:function(c,a){var e=this,d=this.getInherited(arguments);return I.parse(t,c,a,function(c,b){return b in y?H.after(t,"on_tracked"+b,a,!0):d.call(e,b,a)})},
tracking:{remove:function(){for(;0<m.length;)m.pop().remove();this.remove=function(){}}},track:null});this.fetchSync&&(z.safeMixin(t,{fetchSync:d(),fetchRangeSync:k()}),t.fetchSync());var A;E.forEach(this.queryLog,function(c){var a=A,e=c.querier;e&&(A=a?function(c){return e(a(c))}:e)});var C={add:{index:void 0},update:{previousIndex:void 0,index:void 0},"delete":{previousIndex:void 0}},G=function(c,a,e,d){d=void 0!==d?d:c.length;for(e=void 0!==e?e:0;e<d;++e)if(r.getIdentity(c[e])===a)return e;return-1};
return t}};p=z(null,C);p.create=function(d,k){d=z.safeMixin(D.delegate(d),C);z.safeMixin(d,k);return d};return p});
//# sourceMappingURL=Trackable.js.map