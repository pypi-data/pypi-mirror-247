//>>built
define("dstore/db/IndexedDB","dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/when dojo/promise/all dstore/Store dstore/SimpleQuery dstore/QueryResults".split(" "),function(E,N,I,F,A,J,O,M){function B(a){var c=new I;a.onsuccess=function(a){c.resolve(a.target.result)};a.onerror=function(){a.error.message=a.webkitErrorMessage;c.reject(a.error)};return c.promise}function G(a,c,b){if(v||w.length){a&&(w.push({cursor:a,priority:c,retry:b}),w.sort(function(a,b){return a.priority>b.priority?1:-1}));
if(1<=v)return;var f=w.pop();a=f&&f.cursor}if(a)try{a["continue"](),v++}catch(d){if("TransactionInactiveError"!==d.name&&0!==d.name||!f)throw d;f.retry()}}function K(){return!0}var w=[],v=0,z=window.IDBKeyRange||window.webkitIDBKeyRange;return E([J,O],{constructor:function(a){E.safeMixin(this,a);var c=this,b=this.dbConfig;this.indices=b.stores[this.storeName];this.cachedCount={};for(var f in c.indices)a=c.indices[f],"number"===typeof a&&(c.indices[f]={preference:a});this.db=this.db||b.db;if(!this.db){var d=
b.openRequest;d||(d=b.openRequest=window.indexedDB.open(b.name||"dojo-db",parseInt(b.version,10)),d.onupgradeneeded=function(){var a=c.db=d.result,f;for(f in b.stores){var q=b.stores[f];if(a.objectStoreNames.contains(f))l=d.transaction.objectStore(f);else{l=q.idProperty||"id";var l=a.createObjectStore(f,{keyPath:l,autoIncrement:q[l]&&q[l].autoIncrement||!1})}for(var e in q)l.indexNames.contains(e)||"autoIncrement"===e||!1===q[e].indexed||l.createIndex(e,e,q[e])}},b.db=B(d));this.db=b.db.then(function(a){return c.db=
a})}},idProperty:"id",storeName:"",indices:{},transaction:function(){var a=this;this._currentTransaction=null;return{abort:function(){a._currentTransaction.abort()},commit:function(){a._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){this._currentTransaction=this.db.transaction([this.storeName],"readwrite");var a=this;this._currentTransaction.oncomplete=function(){a._currentTransaction=null};this._currentTransaction.onerror=function(a){}}return this._currentTransaction},
_callOnStore:function(a,c,b,f){var d=this;return F(this.db,function q(m){d.db.then&&(d.db=m);if(m=d._currentTransaction)var l=!0;else m=d._getTransaction();if(l)try{var e=m.objectStore(d.storeName);b&&(e=e.index(b));var u=e[a].apply(e,c)}catch(r){if("TransactionInactiveError"===r.name||"InvalidStateError"===r.name)return d._currentTransaction=null,q();throw r;}else e=m.objectStore(d.storeName),b&&(e=e.index(b)),u=e[a].apply(e,c);return f?u:B(u)})},get:function(a){var c=this;return this._callOnStore("get",
[a]).then(function(a){return c._restore(a)})},getIdentity:function(a){return a[this.idProperty]},put:function(a,c){c=c||{};this.cachedCount={};var b=this;return this._callOnStore(!1===c.overwrite?"add":"put",[a]).then(function(a){return b._restore(a)})},add:function(a,c){c=c||{};c.overwrite=!1;return this.put(a,c)},remove:function(a){this.cachedCount={};return this._callOnStore("delete",[a])},fetch:function(){return this._fetch(K)},fetchRange:function(a){return this._fetch(K,a)},forEach:function(a,
c){return this._fetch(function(b,f){a.call(c,b,f)})},_union:function(a,c,b){b=b||{};var f=b.start||0,d=b.end||Infinity,t=a.sort,m=a.select;b=a.filter;if(t){var q={sort:t};var l=this._createSortQuerier(q)}else l=function(a){return a};var e=[],u=0,r=0,x=0,y=[],k,h={},n=[],g=this;return new M(F(b).then(function(b){return A(b.map(function(b,m){function q(a){C.push(a);for(var b=[],r=[];y.every(function(a){if(0<a.length)return(a=a[0])&&r.push(a),b.push(a)});){if(x>=d||0===r.length){k=!0;return}a=l(r)[0];
y[b.indexOf(a)].shift();if(x++>=f&&(n.push(a),!c(a))){k=!0;return}b=[];r=[]}return!0}var C=y[m]=[],v=g._query({filterFunction:a.filterFunction,filter:b,sort:t},function(a){if(!k){var b=g.getIdentity(a);r++;if(b in h)return!0;u++;h[b]=!0;return q(a)}});e[m]=v.totalLength;return v.then(function(a){q(null);return a})}))}).then(function(){return m?m.querier(n):n}),{totalLength:{then:function(){return A(e).then(function(a){return a.reduce(function(a,b){return a+b})*u/(r||1)}).then.apply(this,arguments)}}})},
_normalizeQuery:function(){function a(e){e.forEach(function y(e){if(f)throw Error("Can not process conditions after a union, rearrange the query with the union last");var k=e.type,h=[].slice.call(e.args,0),n=h[0],g=h[1];if(g&&g.fetch&&!g.data)l.push(g.fetch().then(function(a){g.data=a;y(e)},function(a){}));else if("or"===k)c(h);else if("and"===k)a(h);else if("eq"===k)b(n,g);else if("gt"===k||"gte"===k)h=d[n]||(d[n]={}),h.from=g,h.excludeFrom="gt"===k,b(n,h);else if("lt"===k||"lte"===k)h=d[n]||(d[n]=
{}),h.to=g,h.excludeTo="lt"===k,b(n,h);else if("in"===k)c((g.data||g).map(function(a){return{type:"eq",args:[n,a]}}));else if("contains"===k)h=d[n]||(d[n]={}),h.contains=g.data?g.data:g instanceof Array?g:[g],b(n,h);else if("match"===k){g=g.source;if("^"!==g[0]||g.match(/[\{\}\(\)\[\]\.,\$\*]/))throw Error("The match filter only supports simple prefix matching like /^starts with/");h=d[n]||(d[n]={});g=g.slice(1);h.from=g;h.to=g+"~";b(n,h)}else throw Error('Unsupported filter type "'+k+'"');})}function c(b){f=
b.map(function(b){d={};a([b]);return d})}function b(a,b){"boolean"!==typeof b&&(b&&(b.from||b.to?function(a,c){b.test=function(b){return!a||a<=b&&(!c||c>=b)};b.keyRange=a?c?z.bound(a,c,b.excludeFrom,b.excludeTo):z.lowerBound(a,b.excludeFrom):z.upperBound(c,b.excludeTo)}(b.from,b.to):"object"===typeof b&&b.contains&&function(a){var c=a[0];if("object"===typeof c&&"match"===c.type){if("^"===c.args[1].source[0]){var d=c.args[1].source.slice(1);d=z.bound(d,d+"~")}}else d=z.only(c);b.test=function(b){return a.every(function(a){if("object"===
typeof a&&"match"===a.type){var c=a.args[1];return b.some(function(a){return!!c.test(a)})}return b&&-1<b.indexOf(a)})};b.keyRange=d}(b.contains)),d[a]=b)}var f,d={},t,m,q,l=[];this.queryLog.forEach(function(b){var c=b.type,d=b.normalizedArguments;if("filter"===c){t=d;var f=e;e=f?function(a){return b.querier(f(a))}:b.querier;a(d,!0)}else"sort"===c?(m=d[0],m.querier=b.querier):"select"===c&&(q=b)});var e=e||function(a){return a};return{filter:0<l.length?A(l).then(function(){return f}):f||d,filterFunction:e,
filterOperator:t||null,sort:m,select:q}},_fetch:function(a,c){var b=this._normalizeQuery(),f=b.filter,d=this;return f instanceof Array||f.then?this._union(b,function(b){a(d._restore(b));return!0},c):this._query(b,function(b){a(d._restore(b));return!0},c)},_query:function(a,c,b){function f(a,b,c){u++;var d=t.indices[a];if(d&&!1!==d.indexed&&(b=b||d.preference*(c||1)||.001,b>e))return e=b,l=a,!0;u++}function d(){function a(a){v--;r.reject(a);G()}F(t._callOnStore("openCursor",B,l,!0),function(f){v++;
f.onsuccess=function(a){v--;var e=a.target.result;if(e){if(D){e.advance(D);v++;D=!1;return}p.preFilterOffset++;try{var g=e.value;b.join&&(g=b.join(g));return F(g,function(a){if(0<y([a]).length&&(p.offset++,p.offset>=m&&(L.push(a),!c(a,p.offset-m)||p.offset>=q-1))){f.lastCursor=e;r.resolve(L);G();return}return G(e,b.priority,function(){D=p.preFilterOffset+1;d()})})}catch(P){r.reject(P)}}else{if(!m||p.offset>=m)p.finished=!0;r.resolve(L)}G()};f.onerror=a},a)}b=b||{};var t=this,m=b.start||0,q=b.end||
Infinity,l,e=0,u=0,r=new I,x=r.promise,y=a.filterFunction;var k=a.filter;var h=a.sort,n=a.select,g;for(g in k){var C=k[g];f(g,null,C&&(C.from||C.to)?.1:1)}var w=JSON.stringify(a.filterOperator)+"-"+JSON.stringify(h);if(h)if(a=h[0],a.property===l||f(a.property,1))var A=a.descending;else{var E=!0;m=0;q=Infinity}if(l){var H=l in k?(k=k[l])&&k.keyRange?k.keyRange:z.only(k):null;var B=[H,A?"prev":"next"]}else B=[];var p=t.cachedPosition;if(p&&p.queryId===w&&p.offset<m&&1<u){var D=p.preFilterOffset+1;t.cachedPosition=
p=N.mixin({},p)}else p=t.cachedPosition={offset:-1,preFilterOffset:-1,queryId:w},2>u&&(p.offset=p.preFilterOffset=(D=m)-1);var L=[];d();if(E){var J=c;c=K;x=x.then(function(a){var c=b.start||0,d=b.end||Infinity;a=h.querier(a).slice(c,d);a.forEach(J);return a})}n&&(x=x.then(function(a){return n.querier(a)}));return new M(x,{totalLength:{then:function(a,b){function c(a){t.cachedCount[w]=a;return Math.round((p.offset+1.01)/(p.preFilterOffset+1.01)*a)}var d=t.cachedCount[w];return d?a(c(d)):p.finished?
(d=new I,d.resolve(p.offset+1),d.then(a)):(H?t._callOnStore("count",[H],l):t._callOnStore("count")).then(c).then(a,b)}}})}})});
//# sourceMappingURL=IndexedDB.js.map