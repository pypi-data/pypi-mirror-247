//>>built
define("dgrid/Editor","dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/dom-construct dojo/dom-class dojo/on dojo/has dojo/query ./Grid dojo/_base/sniff".split(" "),function(v,q,n,r,t,l,u,w,x){return v(null,{constructor:function(){this._editorInstances={};this._editorColumnListeners=[];this._editorCellListeners={};this._editorsPendingStartup=[]},postCreate:function(){var a=this;this.inherited(arguments);this.on(".dgrid-input:focusin",function(){a._focusedEditorCell=a.cell(this)});this._editorFocusoutHandle=
l.pausable(this.domNode,".dgrid-input:focusout",function(){a._focusedEditorCell=null});this._listeners.push(this._editorFocusoutHandle)},insertRow:function(){this._editorRowListeners={};var a=this.inherited(arguments),b=this.row(a),c=this._editorCellListeners[a.id]=this._editorCellListeners[a.id]||{},d;for(d in this._editorRowListeners)c[d]=this._editorRowListeners[d];this._editorRowListeners=null;(c=this._previouslyFocusedEditorCell)&&c.row.id===b.id&&this.edit(this.cell(b,c.column.id));return a},
refresh:function(){for(var a in this._editorInstances){var b=this._editorInstances[a].domNode;b&&b.parentNode&&b.parentNode.removeChild(b)}this.inherited(arguments)},removeRow:function(a){var b=this,c=this._focusedEditorCell;c&&c.row.id===this.row(a).id&&(this._previouslyFocusedEditorCell=c,this._editorFocusoutHandle.pause(),setTimeout(function(){b._editorFocusoutHandle.resume();b._previouslyFocusedEditorCell=null},0));if(this._editorCellListeners[a.id]){for(var d in this._editorCellListeners[a.id])this._editorCellListeners[a.id][d].remove();
delete this._editorCellListeners[a.id]}for(c=this._alwaysOnWidgetColumns.length;c--;)if(d=(d=this.cell(a,this._alwaysOnWidgetColumns[c].id).element)&&(d.contents||d).widget)this._editorFocusoutHandle.pause(),d.destroyRecursive();return this.inherited(arguments)},renderArray:function(){var a=this.inherited(arguments);a.length?this._startupPendingEditors():this._editorsPendingStartup=[];return a},_onNotification:function(){this.inherited(arguments);this._startupPendingEditors()},_destroyColumns:function(){this._editorStructureCleanup();
this.inherited(arguments)},_editorStructureCleanup:function(){var a=this._editorInstances,b=this._editorColumnListeners;this._editTimer&&clearTimeout(this._editTimer);for(var c in a){var d=a[c];d.domNode&&d.destroyRecursive()}this._editorInstances={};for(a=b.length;a--;)b[a].remove();for(var e in this._editorCellListeners)for(c in this._editorCellListeners[e])this._editorCellListeners[e][c].remove();for(a=0;a<this._editorColumnListeners.length;a++)this._editorColumnListeners[a].remove();this._editorCellListeners=
{};this._editorColumnListeners=[];this._editorsPendingStartup=[]},_configColumns:function(){var a=this.inherited(arguments);this._alwaysOnWidgetColumns=[];for(var b=0,c=a.length;b<c;b++)a[b].editor&&this._configureEditorColumn(a[b]);return a},_configureEditorColumn:function(a){var b=this,c=a.renderCell||this._defaultRenderCell,d=a.editOn,e="string"!==typeof a.editor;d?this._editorInstances[a.id]=this._createSharedEditor(a,c):e&&this._alwaysOnWidgetColumns.push(a);a.renderCell=d?function(h,e,f,g){if(!g||
!g.alreadyHooked){var k=l(f,d,function(){b._activeOptions=g;b.edit(this)});if(b._editorRowListeners)b._editorRowListeners[a.id]=k;else{var m=b.row(h);b._editorCellListeners[m.element.id][a.id]=k}}return c.call(a,h,e,f,g)}:function(d,k,f,g){if(!a.canEdit||a.canEdit(d,k))d=b._createEditor(a,d),b._showEditor(d,a,f,k),f[e?"widget":"input"]=d;else return c.call(a,d,k,f,g)}},edit:function(a){function b(a){c._activeCell=f;c._showEditor(e,h,f,l);c._editTimer=setTimeout(function(){e.focus&&e.focus();h._editorBlurHandle&&
h._editorBlurHandle.resume();c._editTimer=null;a.resolve(e)},0)}var c=this,d,e;a.column||(a=this.cell(a));if(!a||!a.element)return null;var h=a.column;var k=h.field;var f=a.element.contents||a.element;if(e=this._editorInstances[h.id]){if(this._activeCell!==f){var g=a.row;var l=(d=this.dirty&&this.dirty[g.id])&&k in d?d[k]:h.get?h.get(g.data):g.data[k];if(!h.canEdit||h.canEdit(a.row.data,l)){var m=new n;a=e.domNode||e;a.offsetWidth?(a.blur(),setTimeout(function(){b(m)},0)):b(m);return m.promise}}}else if(h.editor&&
(e=f.widget||f.input))return m=new n,e.focus&&e.focus(),m.resolve(e),m.promise;return null},refreshCell:function(a){var b=a.column,c=b.get?b.get(a.row.data):a.row.data[b.field],d;b.editor&&(a.column.editOn&&this._activeCell===a.element?d=this._editorInstances[a.column.id]:a.column.editOn||(d=a.element.widget||a.element.input));return d?(d.domNode?d.set("value",c):this._updateInputValue(d,c),(new n).resolve()):this.inherited(arguments)},_showEditor:function(a,b,c,d){var e=a.domNode;e||this._updateInputValue(a,
d);c.innerHTML="";t.add(c,"dgrid-cell-editing");e&&b.editOn&&a.validate&&a.reset&&a.reset();c.appendChild(a.domNode||a);e&&!b.editOn?this._editorsPendingStartup.push([a,b,c,d]):this._startupEditor(a,b,c,d)},_startupEditor:function(a,b,c,d){a.domNode&&(a._started||a.startup(),a._dgridIgnoreChange=!0,a.set("value",d),setTimeout(function(){a._dgridIgnoreChange=!1},0));a._dgridLastValue=d;this._activeCell&&(this._activeValue=d,l.emit(c,"dgrid-editor-show",{grid:this,cell:this.cell(c),column:b,editor:a,
bubbles:!0,cancelable:!1}))},_startupPendingEditors:function(){for(var a=this._editorsPendingStartup,b=a.length;b--;)this._startupEditor.apply(this,a[b]);this._editorsPendingStartup=[]},_handleEditorChange:function(a,b){var c=a.target;"_dgridLastValue"in c&&-1<c.className.indexOf("dgrid-input")&&this._updatePropertyFromEditor(b||this.cell(c).column,c,a)},_createEditor:function(a,b){var c=a.editor,d=a.editOn,e=this,h="string"!==typeof c&&c,k={};var f=a.editorArgs||{};"function"===typeof f&&(f=f.call(this,
a));if(h){var g=new h(f);f=g.focusNode||g.domNode;f.className+=" dgrid-input";g.on(d?"blur":"change",function(){g._dgridIgnoreChange||e._updatePropertyFromEditor(a,this,{type:"widget"})})}else this._hasInputListener||(this._hasInputListener=!0,this.on("change",function(a){e._handleEditorChange(a)})),"textarea"===c?h="textarea":(h="input",k.type=c),g=f=r.create(h,q.mixin(k,{className:"dgrid-input",name:a.field,tabIndex:isNaN(a.tabIndex)?-1:a.tabIndex},f)),9>u("ie")&&(c="radio"===c||"checkbox"===c?
l(g,"click",function(b){e._handleEditorChange(b,a)}):l(g,"change",function(b){e._handleEditorChange(b,a)}),d?this._editorColumnListeners.push(c):this._editorRowListeners?this._editorRowListeners[a.id]=c:this._editorCellListeners[this.row(b).element.id][a.id]=c);if(a.autoSelect){var p=g.focusNode||g;p.select&&l(p,"focus",function(){setTimeout(function(){p.select()},0)})}return g},_createSharedEditor:function(a){function b(){var a=d._activeCell;k.blur();"function"===typeof d.focus&&setTimeout(function(){d.focus(a)},
e&&9>u("ie")?15:0)}var c=this._createEditor(a),d=this,e=c.domNode,h=c.domNode||c,k=c.focusNode||h,f=e?function(){c.set("value",c._dgridLastValue)}:function(){d._updateInputValue(c,c._dgridLastValue);d._updatePropertyFromEditor(a,c)};this._editorColumnListeners.push(l(k,"keydown",function(g){g=g.keyCode||g.which;27===g?(f(),d._activeValue=c._dgridLastValue,b()):13===g&&!1!==a.dismissOnEnter&&b()}));(a._editorBlurHandle=l.pausable(c,"blur",function(){var b=h.parentNode,e={alreadyHooked:!0},f=d.cell(h);
l.emit(f.element,"dgrid-editor-hide",{grid:d,cell:f,column:a,editor:c,bubbles:!0,cancelable:!1});a._editorBlurHandle.pause();b.removeChild(h);f.row&&(t.remove(f.element,"dgrid-cell-editing"),r.empty(b),x.appendIfNode(b,a.renderCell(f.row.data,d._activeValue,b,d._activeOptions?q.delegate(e,d._activeOptions):e)));d._focusedEditorCell=d._activeCell=d._activeValue=d._activeOptions=null})).pause();this._editorColumnListeners.push(a._editorBlurHandle);return c},_updatePropertyFromEditor:function(a,b,c){var d;
if(!b.isValid||b.isValid())if(c=this._updateProperty((b.domNode||b).parentNode,this._activeCell?this._activeValue:b._dgridLastValue,this._retrieveEditorValue(a,b),c),this._activeCell?this._activeValue=c:b._dgridLastValue=c,"radio"===b.type&&b.name&&!a.editOn&&a.field)for(d in c=this.row(b),w("input[type\x3dradio][name\x3d"+b.name+"]",this.contentNode).forEach(function(c){var d=this.row(c);c!==b&&c._dgridLastValue&&(c._dgridLastValue=!1,this.updateDirty?this.updateDirty(d.id,a.field,!1):d.data[a.field]=
!1)},this),this.dirty)c.id.toString()!==d&&this.dirty[d][a.field]&&this.updateDirty(d,a.field,!1)},_updateProperty:function(a,b,c,d){var e=this;if((b&&b.valueOf())!==(c&&c.valueOf())){var h=this.cell(a),k=h.row,f=h.column;a=h.element;if(f.field&&k)if(h={grid:this,cell:h,oldValue:b,value:c,bubbles:!0,cancelable:!0},d&&d.type&&(h.parentType=d.type),l.emit(a,"dgrid-datachange",h))this.updateDirty?(this.updateDirty(k.id,f.field,c),f.autoSave&&setTimeout(function(){e._trackError("save")},0)):k.data[f.field]=
c;else{var g;(g=a.widget)?(g._dgridIgnoreChange=!0,g.set("value",b),setTimeout(function(){g._dgridIgnoreChange=!1},0)):(g=a.input)&&this._updateInputValue(g,b);return b}}return c},_updateInputValue:function(a,b){a.value=b;if("radio"===a.type||"checkbox"===a.type)a.checked=a.defaultChecked=!!b},_retrieveEditorValue:function(a,b){return"function"===typeof b.get?this._convertEditorValue(b.get("value")):this._convertEditorValue(b["checkbox"===b.type||"radio"===b.type?"checked":"value"])},_convertEditorValue:function(a,
b){if("number"===typeof b)a=isNaN(a)?a:parseFloat(a);else if("boolean"===typeof b)a="true"===a?!0:"false"===a?!1:a;else if(b instanceof Date){var c=new Date(a);a=isNaN(c.getTime())?a:c}return a}})});
//# sourceMappingURL=Editor.js.map